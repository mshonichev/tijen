---
- scm:
    name: tiden-repo
    scm:
      - git:
          url: https://github.com/ggprivate/tiden.git
          branches:
            - '*/master'
          credentials-id: mshonichev
          timeout: 20
          basedir: tiden

- project:
    name: tiden-release-tasks
    ignite_version: 0
    gridgain_version: 0
    root_folder_name: release
    root_folder_display_name: Release
    edition_display_name: GridGain Ultimate Edition
    edition_short_display_name: GG UE
    edition_name: gridgain-ultimate-fabric

- job-template:
    name: '{job_folder}/tiden-{suite_name}'
    id: job-tiden
    project-type: freestyle
    parameters:
      - string:
          name: IGNITE_VERSION
          default: '2.5.1-p8'
          description: "Apache Ignite version, ex. 2.5.1"
      - string:
          name: GRIDGAIN_VERSION
          default: '8.5.1-p8'
          description: "GridGain version, ex. 8.5.1"
      - string:
          name: ATTR
          default:
          description: "Attributes list for test selection, comma separated. You can put tests names here."
      - string:
          name: SERVER_HOSTS
          default: '172.25.1.37,172.25.1.38'
          description: "IP for server hosts separated with comma. Please rewrite the default value."
      - string:
          name: CLIENT_HOSTS
          default: '172.25.1.37,172.25.1.38'
          description: "IP for client hosts, separated with comma. Please rewrite the default value."
      - choice:
          name: ATTR_MATCH
          choices:
            - any
            - all
          description: "Attribute match policy. Applies only when 'ATTR' is not empty."
    scm:
      - tiden-repo
    builders:
      - build-name-setter:
          template: '#$BUILD_NUMBER - $GRIDGAIN_VERSION'
          macro: true
      - config-file-provider:
          files:
            - file-id: 6fbbc991-7e18-40d3-a1b3-090fbc4dbe19
              target: $WORKSPACE/qa_ftp.yaml
      - shell: |
          echo "#### Cleanup & create work/var folders at '$WORKSPACE' ####"
          rm -rf $WORKSPACE/work 2>/dev/null
          rm -rf $WORKSPACE/var 2>/dev/null
          mkdir -p $WORKSPACE/work
          mkdir -p $WORKSPACE/var

          echo "#### Prepare working directory for '$GRIDGAIN_VERSION/$IGNITE_VERSION' ####"
          cd tiden

          bash \
              utils/prepare_work_dir.sh \
                  --work-dir=$WORKSPACE/work \
                  --var-dir=$WORKSPACE/var \
                  --config=$WORKSPACE/qa_ftp.yaml \
                  --fetch-deps

          bash \
              utils/prepare_artifacts_config.sh \
                  --work-dir=$WORKSPACE/work \
                  --config=$WORKSPACE/tiden/config/jenkins-artifacts-gg-ult-fab.yaml

          # just copy environment config to working directory for convenience
          cp -f \
              $WORKSPACE/config/env_jenkins.yaml \
              $WORKSPACE/work/
      - shell: |
          cd tiden
          bash utils/run-tests.sh {suite_name}
- job-template:
    name: '{folder_name}'
    id: 'job-folder'
    project-type: folder
    display-name: '{folder_display_name}'
